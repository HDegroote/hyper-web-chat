<app>
    <nav class="uk-navbar-container uk-navbar-transparent" uk-navbar>
        <div class="uk-navbar-left">
            <ul class="uk-iconnav">
                <li class="uk-margin">
                    <a href="#" 
                       style="margin-top:13px" 
                       uk-icon="icon:list;" 
                       uk-tooltip="name:ðŸšª Open; delay:500; ratio: 3.5" 
                       uk-toggle="#channal-list"></a>
                </li>
                <li class="uk-margin">
                    <b class="channelname">{state.channelName}</b>
                </li>
            </ul>
        </div>
        <div class="uk-navbar-right">
            <ul class="uk-iconnav">
                <li class="uk-margin-right">
                    <a href="#" style="margin-top:13px" uk-icon="icon: users;" uk-tooltip="title:user deets; delay:500"
                        uk-toggle="#user-list"></a>
                </li>
                <li class="uk-margin-right">
                    <a href="#" style="margin-top:13px" uk-icon="icon: world;" uk-tooltip="title: browser; delay: 500"
                    uk-toggle="#terminal"></a>
                </li>
            </ul>
        </div>
        <div class="uk-navbar-right">
            <ul class="uk-iconnav">
                <li class="uk-margin-right">
                </li>
            </ul>
        </div>
    </nav>
    <messages channel={state.channelName} messages={state.messages[state.channelName]} emit={emit}></messages>
    <channellist channels={state.channels} emit={emit} parentUpdate={update}></channellist>
    <userlist name={state.name}></userlist>
    <terminal hash={state.channelName}></terminal>
    <script>
        export default {
            state:{messages:{}, modalContent:''},
            actions:window.actions,
            emit(action, input='') {
                const self = this;
                const socket = window.socket;
                return new Promise((res)=>{
                    if(socket && socket.readyState === WebSocket.CONNECTING) {
                        console.log('not connected, waiting');
                        socket.addEventListener('open', (event) => {
                            console.log('socket open');
                            res(socket.send(sign({ action, input, keyPair })));
                        });
                    } else if(socket && socket.readyState === WebSocket.OPEN) {
                        res(socket.send(sign({ action, input, keyPair })))
                    };
                })
            },
            onMounted() {
                const self = this;
                 var timeout = 10;
                function connect(address, protocols, options) {
                    let ws = new WebSocket(address, protocols, options);
                    let timerTimeout = setTimeout(() => ws.close(), timeout * 1000); // force close unless cleared on 'open'
                    ws.addEventListener('open', (event) => {
                        console.log('Opened. Clearing timeout ...');
                        clearTimeout(timerTimeout);
                        // do your thing here, like ws.send(...);
                    });
                    ws.onmessage = async function (event) {
                        var arrayBuffer = await event.data.arrayBuffer();
                        var buffer = Buffer.from(arrayBuffer);
                        const message = packr.unpack(buffer);
                        if(typeof this.actions[message.action] == 'function') actions[message.action].bind(self)(message.i);
                    }.bind(this);
                    ws.addEventListener('close', (event) => {
                        clearTimeout(timerTimeout);
                        console.error('Websocket connection closed. Reconnecting in %f seconds ...', timeout);
                        setTimeout(() => connect(address, protocols, options), timeout * 1000);
                    });
                    ws.addEventListener('error', reason => console.error('Websocket error: ', reason));
                    return ws;
                }
                window.socket = connect("wss://"+window.location.host)
                console.log('mounted', this);
                this.emit('getChannels')
                this.emit('getProfile')
            }
        }
    </script>
</app>